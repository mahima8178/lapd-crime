{
  "query": {
    "display_name": "03_silver_fact",
    "warehouse_id": "ba90f266beeaacb2",
    "query_text": "-- 03_silver_fact.sql\n-- Goal: Silver fact table (cleaned + dedup by DR_NO)\n-- Uses Socrata JSON field names (snake_case) commonly returned by the API.\n-- If your keys differ, update column references here only.\n\nUSE CATALOG public_crime;\nUSE SCHEMA silver;\n\nCREATE TABLE IF NOT EXISTS crime_event_clean\nTBLPROPERTIES (\n  'delta.enableChangeDataFeed' = 'true'\n)\nAS\nWITH base AS (\n  SELECT\n    CAST(dr_no AS STRING)                     AS dr_no,\n    TRY_TO_TIMESTAMP(date_rptd)               AS date_rptd_ts,\n    TRY_TO_TIMESTAMP(date_occ)                AS date_occ_ts,\n    CAST(time_occ AS STRING)                  AS time_occ,\n    CAST(area AS INT)                         AS area,\n    CAST(area_name AS STRING)                 AS area_name,\n    CAST(rpt_dist_no AS STRING)               AS rpt_dist_no,\n    CAST(part_1_2 AS STRING)                  AS part_1_2,\n    CAST(crm_cd AS INT)                       AS crm_cd,\n    CAST(crm_cd_desc AS STRING)               AS crm_cd_desc,\n    CAST(mocodes AS STRING)                   AS mocodes,\n    CAST(vict_age AS INT)                     AS vict_age,\n    CAST(vict_sex AS STRING)                  AS vict_sex,\n    CAST(vict_descent AS STRING)              AS vict_descent,\n    CAST(premis_cd AS INT)                    AS premis_cd,\n    CAST(premis_desc AS STRING)               AS premis_desc,\n    CAST(weapon_used_cd AS INT)               AS weapon_used_cd,\n    CAST(weapon_desc AS STRING)               AS weapon_desc,\n    CAST(status AS STRING)                    AS status,\n    CAST(status_desc AS STRING)               AS status_desc,\n    CAST(crm_cd_1 AS INT)                     AS crm_cd_1,\n    CAST(crm_cd_2 AS INT)                     AS crm_cd_2,\n    CAST(crm_cd_3 AS INT)                     AS crm_cd_3,\n    CAST(crm_cd_4 AS INT)                     AS crm_cd_4,\n    CAST(location AS STRING)                  AS location,\n    CAST(cross_street AS STRING)              AS cross_street,\n    CAST(lat AS DOUBLE)                       AS lat,\n    CAST(lon AS DOUBLE)                       AS lon,\n\n    -- Prefer Socrata system timestamp if present; otherwise fall back to reported timestamp.\n    COALESCE(TRY_TO_TIMESTAMP(`:updated_at`), TRY_TO_TIMESTAMP(date_rptd)) AS updated_at_ts,\n\n    -- Stable hash for joins/dedup\n    SHA2(CONCAT_WS('|',\n      COALESCE(CAST(dr_no AS STRING), ''),\n      COALESCE(CAST(crm_cd AS STRING), ''),\n      COALESCE(CAST(date_occ AS STRING), ''),\n      COALESCE(CAST(time_occ AS STRING), '')\n    ), 256) AS event_hash\n  FROM public_crime.bronze.lapd_crime_raw_json\n),\ndedup AS (\n  SELECT\n    *,\n    ROW_NUMBER() OVER (\n      PARTITION BY dr_no\n      ORDER BY updated_at_ts DESC NULLS LAST, date_rptd_ts DESC NULLS LAST\n    ) AS rn\n  FROM base\n)\nSELECT\n  dr_no,\n  event_hash,\n  DATE(date_occ_ts)     AS occurrence_date,\n  DATE(date_rptd_ts)    AS reported_date,\n  updated_at_ts,\n  time_occ,\n  area,\n  area_name,\n  rpt_dist_no,\n  part_1_2,\n  crm_cd,\n  crm_cd_desc,\n  mocodes,\n  vict_age,\n  vict_sex,\n  vict_descent,\n  premis_cd,\n  premis_desc,\n  weapon_used_cd,\n  weapon_desc,\n  status,\n  status_desc,\n  crm_cd_1,\n  crm_cd_2,\n  crm_cd_3,\n  crm_cd_4,\n  location,\n  cross_street,\n  lat,\n  lon\nFROM dedup\nWHERE rn = 1;\n\n-- Sanity\nSELECT COUNT(*) AS silver_rows FROM crime_event_clean;\nSELECT * FROM crime_event_clean LIMIT 5;\n"
  }
}
